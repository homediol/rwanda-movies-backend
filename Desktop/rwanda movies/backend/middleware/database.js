const sequelize = require('../config/database');\n\n/**\n * Database middleware with automatic reconnection and error handling\n */\nclass DatabaseMiddleware {\n  constructor() {\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n    this.reconnectDelay = 1000; // Start with 1 second\n  }\n\n  /**\n   * Wrap database queries with automatic retry and reconnection\n   */\n  async executeQuery(queryFunction, maxRetries = 3) {\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      try {\n        // Check connection health before executing query\n        await this.ensureConnection();\n        \n        // Execute the query\n        const result = await queryFunction();\n        \n        // Reset reconnect attempts on successful query\n        this.reconnectAttempts = 0;\n        \n        return result;\n      } catch (error) {\n        console.error(`Query attempt ${attempt} failed:`, error.message);\n        \n        // Check if it's a connection-related error\n        if (this.isConnectionError(error)) {\n          console.log('Connection error detected, attempting to reconnect...');\n          await this.handleConnectionError();\n        }\n        \n        // If this is the last attempt, throw the error\n        if (attempt === maxRetries) {\n          throw error;\n        }\n        \n        // Wait before retrying\n        await this.delay(1000 * attempt);\n      }\n    }\n  }\n\n  /**\n   * Ensure database connection is healthy\n   */\n  async ensureConnection() {\n    try {\n      await sequelize.authenticate();\n    } catch (error) {\n      console.error('Connection check failed:', error.message);\n      await this.handleConnectionError();\n    }\n  }\n\n  /**\n   * Handle connection errors with automatic reconnection\n   */\n  async handleConnectionError() {\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n      throw new Error('Maximum reconnection attempts exceeded');\n    }\n\n    this.reconnectAttempts++;\n    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);\n    \n    console.log(`Reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${delay}ms...`);\n    \n    await this.delay(delay);\n    \n    try {\n      // Close existing connections\n      await sequelize.close();\n      \n      // Wait a bit before reconnecting\n      await this.delay(1000);\n      \n      // Authenticate to establish new connection\n      await sequelize.authenticate();\n      \n      console.log('✅ Database reconnection successful');\n      this.reconnectAttempts = 0;\n    } catch (error) {\n      console.error('❌ Reconnection failed:', error.message);\n      throw error;\n    }\n  }\n\n  /**\n   * Check if error is connection-related\n   */\n  isConnectionError(error) {\n    const connectionErrors = [\n      'ECONNRESET',\n      'ECONNREFUSED', \n      'ETIMEDOUT',\n      'EHOSTUNREACH',\n      'EPIPE',\n      'PROTOCOL_CONNECTION_LOST',\n      'SequelizeConnectionError',\n      'SequelizeConnectionRefusedError',\n      'SequelizeHostNotFoundError',\n      'SequelizeHostNotReachableError',\n      'SequelizeInvalidConnectionError',\n      'SequelizeConnectionTimedOutError'\n    ];\n    \n    return connectionErrors.some(errorType => \n      error.message.includes(errorType) || \n      error.name.includes(errorType) ||\n      error.code === errorType\n    );\n  }\n\n  /**\n   * Utility function for delays\n   */\n  delay(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Express middleware for database operations\n   */\n  middleware() {\n    return (req, res, next) => {\n      // Add database helper to request object\n      req.db = {\n        execute: (queryFunction) => this.executeQuery(queryFunction)\n      };\n      next();\n    };\n  }\n\n  /**\n   * Get connection pool statistics\n   */\n  getPoolStats() {\n    const pool = sequelize.connectionManager.pool;\n    return {\n      total: pool.size,\n      active: pool.used.length,\n      idle: pool.available.length,\n      pending: pool.pending.length\n    };\n  }\n}\n\n// Create singleton instance\nconst dbMiddleware = new DatabaseMiddleware();\n\nmodule.exports = {\n  DatabaseMiddleware,\n  dbMiddleware,\n  // Export middleware function\n  middleware: dbMiddleware.middleware.bind(dbMiddleware),\n  // Export query executor\n  executeQuery: dbMiddleware.executeQuery.bind(dbMiddleware),\n  // Export pool stats\n  getPoolStats: dbMiddleware.getPoolStats.bind(dbMiddleware)\n};", "oldStr": "", "newStr": ""}]