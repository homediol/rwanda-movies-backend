# Database Connection Issues - Diagnosis & Solutions\n\n## ðŸ” Problem Analysis\n\nYour application was experiencing database connection drops after some time due to several common issues:\n\n### 1. **Connection Pool Exhaustion**\n- Too many connections being created without proper cleanup\n- Long-running queries blocking connection pool\n- Idle connections timing out\n\n### 2. **Missing Error Handling**\n- Unhandled promise rejections\n- Uncaught exceptions crashing the process\n- No automatic reconnection logic\n\n### 3. **Resource Leaks**\n- Memory leaks from unclosed connections\n- Event listeners not being cleaned up\n- Large objects staying in memory\n\n### 4. **Database Server Timeouts**\n- MySQL `wait_timeout` and `interactive_timeout` settings\n- Network timeouts between app and database\n- Firewall dropping idle connections\n\n## âœ… Solutions Implemented\n\n### 1. **Enhanced Database Configuration**\n\n**File: `backend/config/database.js`**\n\n```javascript\n// Optimized connection pool settings\npool: {\n  max: 10,          // Reduced from 20 to prevent overload\n  min: 2,           // Always keep 2 connections alive\n  acquire: 30000,   // 30s timeout for acquiring connection\n  idle: 10000,      // 10s idle timeout (shorter to prevent stale)\n  evict: 5000,      // Check for idle connections every 5s\n  handleDisconnects: true,\n  validate: (connection) => {\n    return connection && !connection._closing;\n  }\n}\n```\n\n**Key improvements:**\n- Reduced max connections to prevent database overload\n- Shorter idle timeout to prevent stale connections\n- Added connection validation\n- Enhanced retry logic with exponential backoff\n\n### 2. **Automatic Reconnection Middleware**\n\n**File: `backend/middleware/database.js`**\n\n```javascript\n// Usage in routes:\nconst { executeQuery } = require('../middleware/database');\n\n// Wrap database operations\nconst movies = await executeQuery(async () => {\n  return Movie.findAll({ where: { isActive: true } });\n});\n```\n\n**Features:**\n- Automatic retry on connection errors\n- Exponential backoff for reconnection attempts\n- Connection health checks before queries\n- Graceful error handling\n\n### 3. **Comprehensive Error Handling**\n\n**File: `backend/server.js`**\n\n```javascript\n// Global error handlers\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('âŒ Unhandled Rejection:', reason);\n});\n\nprocess.on('uncaughtException', (error) => {\n  console.error('âŒ Uncaught Exception:', error);\n  gracefulShutdown('UNCAUGHT_EXCEPTION');\n});\n```\n\n### 4. **System Monitoring**\n\n**File: `backend/utils/monitoring.js`**\n\n- Real-time memory and CPU monitoring\n- Database connection pool statistics\n- Automatic alerts for high resource usage\n- Health check endpoints\n\n### 5. **Production Process Management**\n\n**File: `ecosystem.config.js`**\n\n```javascript\n// PM2 configuration\n{\n  instances: 'max',           // Use all CPU cores\n  max_memory_restart: '1G',   // Restart if memory > 1GB\n  cron_restart: '0 3 * * *',  // Daily restart at 3 AM\n  autorestart: true,          // Auto restart on crash\n  exp_backoff_restart_delay: 100 // Exponential backoff\n}\n```\n\n## ðŸš€ Quick Start\n\n### 1. **Development Mode**\n```bash\n# Install dependencies and start development\nnpm run install-all\nnpm run start:dev\n```\n\n### 2. **Production Setup**\n```bash\n# Run the production setup script\nnpm run setup:prod\n\n# Start in production mode\nnpm run start:prod\n```\n\n### 3. **Monitoring Commands**\n```bash\n# Check application status\nnpm run pm2:status\n\n# View real-time logs\nnpm run pm2:logs\n\n# Monitor system resources\nnpm run pm2:monit\n\n# Manual health check\nnpm run health-check\n```\n\n## ðŸ“Š Health Check Endpoints\n\n### 1. **Basic Health Check**\n```bash\nGET /api/health\n```\n\n**Response:**\n```json\n{\n  \"status\": \"OK\",\n  \"timestamp\": \"2024-01-15T10:30:00.000Z\",\n  \"uptime\": 3600,\n  \"database\": { \"status\": \"healthy\" },\n  \"memory\": {\n    \"rss\": \"150 MB\",\n    \"heapUsed\": \"80 MB\"\n  }\n}\n```\n\n### 2. **Database Status**\n```bash\nGET /api/db-status\n```\n\n**Response:**\n```json\n{\n  \"status\": \"healthy\",\n  \"connections\": {\n    \"total\": 5,\n    \"active\": 2,\n    \"idle\": 3,\n    \"pending\": 0\n  }\n}\n```\n\n## ðŸ”§ Configuration Best Practices\n\n### 1. **MySQL Server Settings**\n\nAdd to your MySQL configuration (`/etc/mysql/my.cnf`):\n\n```ini\n[mysqld]\n# Connection settings\nmax_connections = 200\nwait_timeout = 28800\ninteractive_timeout = 28800\nmax_allowed_packet = 64M\n\n# Performance settings\ninnodb_buffer_pool_size = 1G\ninnodb_log_file_size = 256M\nquery_cache_size = 64M\n```\n\n### 2. **Environment Variables**\n\n**File: `backend/.env.production`**\n\n```env\n# Database Configuration\nDB_HOST=localhost\nDB_PORT=3306\nDB_NAME=rwanda_movies\nDB_USER=root\nDB_PASSWORD=your_secure_password\n\n# Connection Pool Settings\nDB_POOL_MAX=10\nDB_POOL_MIN=2\nDB_ACQUIRE_TIMEOUT=30000\nDB_IDLE_TIMEOUT=10000\n\n# Monitoring\nENABLE_MONITORING=true\nMONITORING_INTERVAL=60000\n```\n\n### 3. **Firewall Configuration**\n\nEnsure your firewall allows persistent connections:\n\n```bash\n# Ubuntu/Debian\nsudo ufw allow 3306/tcp\n\n# CentOS/RHEL\nsudo firewall-cmd --permanent --add-port=3306/tcp\nsudo firewall-cmd --reload\n```\n\n## ðŸš¨ Troubleshooting\n\n### 1. **Connection Pool Exhausted**\n\n**Symptoms:**\n- \"Connection pool exhausted\" errors\n- Slow response times\n- Timeouts\n\n**Solutions:**\n```bash\n# Check active connections\nnpm run pm2:logs | grep \"connection\"\n\n# Restart application\nnpm run pm2:restart\n\n# Check database connections\nmysql -u root -p -e \"SHOW PROCESSLIST;\"\n```\n\n### 2. **Memory Leaks**\n\n**Symptoms:**\n- Increasing memory usage over time\n- Application restarts due to memory limit\n\n**Solutions:**\n```bash\n# Monitor memory usage\nnpm run pm2:monit\n\n# Check for memory leaks\nnode --inspect backend/server.js\n```\n\n### 3. **Database Connection Errors**\n\n**Symptoms:**\n- \"Connection lost\" errors\n- \"ETIMEDOUT\" errors\n- \"ECONNRESET\" errors\n\n**Solutions:**\n```bash\n# Check database status\nnpm run health-check\n\n# Restart MySQL service\nsudo systemctl restart mysql\n\n# Check MySQL error logs\nsudo tail -f /var/log/mysql/error.log\n```\n\n## ðŸ“ˆ Performance Monitoring\n\n### 1. **Key Metrics to Monitor**\n\n- **Memory Usage**: Should stay below 1GB\n- **CPU Usage**: Should stay below 80%\n- **Database Connections**: Active connections should be < 8\n- **Response Time**: API responses should be < 500ms\n- **Error Rate**: Should be < 1%\n\n### 2. **Automated Alerts**\n\nThe monitoring system will automatically log warnings for:\n- High memory usage (> 500MB)\n- High CPU usage (> 80%)\n- Database connection issues\n- High error rates\n\n### 3. **Log Analysis**\n\n```bash\n# View error logs\ntail -f logs/error.log\n\n# Search for connection errors\ngrep -i \"connection\" logs/combined.log\n\n# Monitor health checks\ntail -f logs/health-check.log\n```\n\n## ðŸ”„ Maintenance Schedule\n\n### Daily\n- Automated health checks every 5 minutes\n- Database backup at 2 AM\n- Log rotation at 1 AM\n\n### Weekly\n- Application restart (Sunday 3 AM)\n- Performance review\n- Log analysis\n\n### Monthly\n- Database optimization\n- Security updates\n- Performance tuning\n\n## ðŸ“ž Support\n\nIf you continue to experience issues:\n\n1. Check the health endpoints: `/api/health` and `/api/db-status`\n2. Review the logs: `npm run pm2:logs`\n3. Monitor system resources: `npm run pm2:monit`\n4. Run manual health check: `npm run health-check`\n\nThe enhanced configuration should resolve the database connection dropping issues and provide better monitoring and error handling for production use.", "oldStr": "", "newStr": ""}]