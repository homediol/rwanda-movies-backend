#!/bin/bash\n\n# Rwanda Movies - Production Setup Script\n# This script sets up monitoring, logging, and production environment\n\necho \"ðŸš€ Setting up Rwanda Movies production environment...\"\n\n# Create necessary directories\necho \"ðŸ“ Creating directories...\"\nmkdir -p logs\nmkdir -p uploads/images\nmkdir -p uploads/subtitles\nmkdir -p monitoring\n\n# Install PM2 globally if not installed\nif ! command -v pm2 &> /dev/null; then\n    echo \"ðŸ“¦ Installing PM2...\"\n    npm install -g pm2\nfi\n\n# Install dependencies\necho \"ðŸ“¦ Installing dependencies...\"\ncd backend && npm install\ncd ..\n\n# Set up log rotation\necho \"ðŸ“ Setting up log rotation...\"\ncat > logs/logrotate.conf << EOF\n./logs/*.log {\n    daily\n    missingok\n    rotate 30\n    compress\n    delaycompress\n    notifempty\n    create 0644 $USER $USER\n    postrotate\n        pm2 reloadLogs\n    endscript\n}\nEOF\n\n# Create monitoring script\necho \"ðŸ“Š Creating monitoring script...\"\ncat > monitoring/health-check.js << 'EOF'\nconst axios = require('axios');\nconst fs = require('fs');\nconst path = require('path');\n\nconst API_URL = process.env.API_URL || 'http://localhost:5002';\nconst LOG_FILE = path.join(__dirname, '../logs/health-check.log');\n\nasync function healthCheck() {\n  const timestamp = new Date().toISOString();\n  \n  try {\n    // Check API health\n    const healthResponse = await axios.get(`${API_URL}/api/health`, {\n      timeout: 10000\n    });\n    \n    // Check database status\n    const dbResponse = await axios.get(`${API_URL}/api/db-status`, {\n      timeout: 10000\n    });\n    \n    const logEntry = {\n      timestamp,\n      status: 'healthy',\n      api: healthResponse.data,\n      database: dbResponse.data\n    };\n    \n    // Log to file\n    fs.appendFileSync(LOG_FILE, JSON.stringify(logEntry) + '\\n');\n    \n    // Check for warnings\n    if (dbResponse.data.connections.active > 8) {\n      console.warn(`âš ï¸ High database connections: ${dbResponse.data.connections.active}`);\n    }\n    \n    if (healthResponse.data.memory.heapUsed > 500) {\n      console.warn(`âš ï¸ High memory usage: ${healthResponse.data.memory.heapUsed}MB`);\n    }\n    \n    console.log(`âœ… Health check passed - ${timestamp}`);\n    \n  } catch (error) {\n    const logEntry = {\n      timestamp,\n      status: 'unhealthy',\n      error: error.message,\n      code: error.code\n    };\n    \n    fs.appendFileSync(LOG_FILE, JSON.stringify(logEntry) + '\\n');\n    console.error(`âŒ Health check failed - ${timestamp}: ${error.message}`);\n    \n    // Send alert (you can integrate with Slack, email, etc.)\n    // await sendAlert(error);\n  }\n}\n\n// Run health check\nhealthCheck();\nEOF\n\n# Create database backup script\necho \"ðŸ’¾ Creating backup script...\"\ncat > monitoring/backup.sh << 'EOF'\n#!/bin/bash\n\n# Database backup script\nDATE=$(date +\"%Y%m%d_%H%M%S\")\nBACKUP_DIR=\"./backups\"\nDB_NAME=\"rwanda_movies\"\nDB_USER=\"root\"\nDB_PASSWORD=\"Tunga@2024\"\n\n# Create backup directory\nmkdir -p $BACKUP_DIR\n\n# Create database backup\necho \"ðŸ“¦ Creating database backup...\"\nmysqldump -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/rwanda_movies_$DATE.sql\n\n# Compress backup\ngzip $BACKUP_DIR/rwanda_movies_$DATE.sql\n\n# Remove backups older than 7 days\nfind $BACKUP_DIR -name \"*.sql.gz\" -mtime +7 -delete\n\necho \"âœ… Backup completed: rwanda_movies_$DATE.sql.gz\"\nEOF\n\nchmod +x monitoring/backup.sh\n\n# Create startup script\necho \"ðŸš€ Creating startup script...\"\ncat > start-production.sh << 'EOF'\n#!/bin/bash\n\necho \"ðŸš€ Starting Rwanda Movies in production mode...\"\n\n# Stop any existing processes\npm2 stop rwanda-movies-api 2>/dev/null || true\npm2 delete rwanda-movies-api 2>/dev/null || true\n\n# Start the application\npm2 start ecosystem.config.js --env production\n\n# Save PM2 configuration\npm2 save\n\n# Setup PM2 startup script\npm2 startup\n\necho \"âœ… Application started successfully!\"\necho \"ðŸ“Š Monitor with: pm2 monit\"\necho \"ðŸ“ View logs with: pm2 logs rwanda-movies-api\"\necho \"ðŸ”„ Restart with: pm2 restart rwanda-movies-api\"\nEOF\n\nchmod +x start-production.sh\n\n# Create development startup script\necho \"ðŸ› ï¸ Creating development script...\"\ncat > start-development.sh << 'EOF'\n#!/bin/bash\n\necho \"ðŸ› ï¸ Starting Rwanda Movies in development mode...\"\n\n# Stop any existing processes\npm2 stop rwanda-movies-api 2>/dev/null || true\npm2 delete rwanda-movies-api 2>/dev/null || true\n\n# Start in development mode with watch\npm2 start ecosystem.config.js --env development --watch\n\necho \"âœ… Development server started!\"\necho \"ðŸ“Š Monitor with: pm2 monit\"\necho \"ðŸ“ View logs with: pm2 logs rwanda-movies-api\"\nEOF\n\nchmod +x start-development.sh\n\n# Create monitoring cron jobs\necho \"â° Setting up cron jobs...\"\ncat > monitoring/crontab << 'EOF'\n# Rwanda Movies monitoring cron jobs\n\n# Health check every 5 minutes\n*/5 * * * * cd /path/to/rwanda-movies && node monitoring/health-check.js\n\n# Database backup daily at 2 AM\n0 2 * * * cd /path/to/rwanda-movies && ./monitoring/backup.sh\n\n# Log rotation daily at 1 AM\n0 1 * * * /usr/sbin/logrotate -f /path/to/rwanda-movies/logs/logrotate.conf\n\n# Restart application weekly (Sunday 3 AM)\n0 3 * * 0 pm2 restart rwanda-movies-api\nEOF\n\necho \"ðŸ“‹ To install cron jobs, run:\"\necho \"crontab monitoring/crontab\"\n\n# Create environment template\necho \"ðŸ”§ Creating environment template...\"\ncat > backend/.env.production << 'EOF'\n# Production Environment Variables\nNODE_ENV=production\nPORT=5002\n\n# Database Configuration\nDB_HOST=localhost\nDB_PORT=3306\nDB_NAME=rwanda_movies\nDB_USER=root\nDB_PASSWORD=your_secure_password\n\n# JWT Configuration\nJWT_SECRET=your_super_secure_jwt_secret_key_change_in_production\nSESSION_SECRET=your_super_secure_session_secret_key\n\n# Frontend URL\nFRONTEND_URL=http://localhost:3000\n\n# File Upload Configuration\nMAX_FILE_SIZE=10485760\nUPLOAD_PATH=./uploads\n\n# Monitoring\nENABLE_MONITORING=true\nMONITORING_INTERVAL=60000\n\n# Logging\nLOG_LEVEL=info\nLOG_FILE=./logs/app.log\nEOF\n\necho \"âœ… Production setup completed!\"\necho \"\"\necho \"ðŸ“‹ Next steps:\"\necho \"1. Update backend/.env.production with your actual values\"\necho \"2. Run './start-production.sh' to start in production mode\"\necho \"3. Run './start-development.sh' to start in development mode\"\necho \"4. Install cron jobs: crontab monitoring/crontab\"\necho \"5. Monitor with: pm2 monit\"\necho \"\"\necho \"ðŸ”— Useful commands:\"\necho \"  pm2 status          - View process status\"\necho \"  pm2 logs            - View logs\"\necho \"  pm2 restart all     - Restart all processes\"\necho \"  pm2 stop all        - Stop all processes\"\necho \"  pm2 delete all      - Delete all processes\"\necho \"  pm2 monit           - Real-time monitoring\"\n", "oldStr": "", "newStr": ""}]